---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { Image } from 'astro:assets';

export async function getStaticPaths() {
  // 1. Hent kolleksjonen med filter for kladder
  const articles = await getCollection('articles', ({ data }) => {
    // I produksjon (når du publiserer) fjerner vi alle kladder.
    // I utvikling (npm run dev) beholder vi dem så du kan forhåndsvise arbeidet ditt.
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  
  // 2. Sorter de filtrerte artiklene
  const sortedArticles = articles.sort((a, b) => 
    b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
  );

  return sortedArticles.map((entry, index) => {
    // Relaterte artikler må også hentes fra den filtrerte listen
    const related = sortedArticles
      .filter(item => item.slug !== entry.slug && item.data.tags.some(tag => entry.data.tags.includes(tag)))
      .slice(0, 3);

    return {
      params: { slug: entry.slug },
      props: { 
        entry,
        prevPost: index === sortedArticles.length - 1 ? null : sortedArticles[index + 1],
        nextPost: index === 0 ? null : sortedArticles[index - 1],
        related
      },
    };
  });
}

const { entry, prevPost, nextPost, related } = Astro.props;
const { Content } = await entry.render();

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('nb-NO', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(date);
};
---

<Layout title={`${entry.data.title} - Comino Web`}>
  <main class="pt-32 pb-20 bg-white dark:bg-slate-950 transition-colors duration-300">
    <article class="container mx-auto px-6 max-w-4xl">
      <header class="mb-12 text-center">
        <div class="flex items-center justify-center gap-3 text-slate-500 dark:text-slate-400 mb-6 font-medium">
          <time datetime={entry.data.publishDate.toISOString()}>
            {formatDate(entry.data.publishDate)}
          </time>
          <span class="w-1.5 h-1.5 rounded-full bg-primary/30"></span>
          <span class="text-primary font-bold uppercase tracking-wider text-xs">
            {entry.data.tags[0]}
          </span>
        </div>
        
        <h1 class="text-4xl md:text-5xl font-bold text-slate-900 dark:text-white leading-tight mb-8 italic">
          {entry.data.title}
        </h1>

        {entry.data.image && (
          <div class="rounded-[2.5rem] overflow-hidden shadow-2xl mb-12 aspect-video border border-slate-100 dark:border-slate-800">
            <Image 
              src={entry.data.image} 
              alt={entry.data.title}
              transition:name={`img-${entry.slug}`}
              class="w-full h-full object-cover rounded-[2.5rem]" 
            />
          </div>
        )}
      </header>

      <div class="prose prose-lg prose-slate dark:prose-invert max-w-none">
        <Content />
      </div>
      
      </article>
  </main>
</Layout>